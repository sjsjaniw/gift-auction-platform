# Gift Auction

Решение задачи по реализации бэкенда для аукционов цифровых подарков.
Основная цель — реализовать механику многораундовых аукционов с корректной обработкой конкурентных запросов и финансовой логики.

## Как я понял задачу (Механика)

В ТЗ не было жестких требований, поэтому логика аукциона реализована следующим образом (на основе анализа реальных аукционов Telegram):

1. **Раунды и распределение**
   Весь пул подарков (например, 1000 шт) делится на 50 раундов. В каждом раунде разыгрывается по 20 подарков.
   - Первый раунд длится 1 час (для сбора участников).
   - Последующие раунды — по 5 минут.
   - Победители раунда (топ-20) получают подарок и выбывают из аукциона.
   - Проигравшие автоматически переходят в следующий раунд с сохранением своих ставок.

2. **Ценообразование**
   Изначально есть фиксированная стартовая цена.
   Как только количество участников превышает количество призов (конкуренция), включается динамическая минимальная ставка. Она рассчитывается как:
   `Цена ставки последнего победного места + 1`.
   Это заставляет участников перебивать нижнюю границу топа.

3. **Работа с деньгами**
   - При ставке средства списываются с основного баланса и переходят в "замороженный" (frozen).
   - Если пользователь побеждает: замороженные средства списываются окончательно, выдается подарок.
   - Если пользователь проигрывает (аукцион завершился, а он не выиграл ни в одном раунде): средства размораживаются и возвращаются на баланс.

4. **Anti-Sniping**
   Если ставка, меняющая состав победителей, делается в последние 30 секунд раунда, то раунд продлевается еще на 30 секунд. Это дает возможность другим участникам отреагировать.

## Техническая реализация

Стек: **Node.js, TypeScript, MongoDB, Redis**.

### Решение проблем конкурентности
Самая важная часть — не допустить двойных списаний и гонки состояний (Race Conditions).
- **База данных:** Используются транзакции MongoDB (Replica Set). Все операции со ставками (проверка баланса -> списание -> запись ставки) происходят атомарно.
- **Блокировки:** Чтобы снизить нагрузку на БД при наплыве запросов от одного юзера или к одному аукциону, используется Redis и алгоритм Redlock.
- **Ранжирование:** Сортировка участников реализована через Redis Sorted Sets (ZSET), так как это быстрее, чем постоянно сортировать массив в Mongo.

### Фоновые задачи
Завершение раунда вынесено в отдельный процесс (воркер). Он следит за временем раундов, определяет победителей, раздает подарки и переключает раунд. Это позволяет API оставаться отзывчивым.

## Запуск проекта локально

Проект упакован в Docker Compose для быстрого запуска.

1. Склонируйте репозиторий:
```bash
git clone https://github.com/sjsjaniw/gift-auction-platform app
cd app
```

2. Запустите проект:
```bash
docker-compose up -d --build
```
Эта команда поднимет API, MongoDB, Redis и веб-интерфейс.

3. Откройте в браузере:
- http://localhost:3000

## Демо-режим и Тестирование

Для проверки работы реализован режим симуляции, доступный через веб-интерфейс.
Кнопка **"Reset & Start Simulation"** выполняет следующий сценарий:

1. **Очистка данных:** Полностью удаляет все данные из базы (пользователи, ставки, аукционы).
2. **Создание аукциона:** Создается тестовый аукцион с ускоренными параметрами:
   - Всего 2 раунда.
   - 10 подарков.
   - Это сделано для того, чтобы можно было быстро (за пару минут) увидеть полный цикл прохождения аукциона, не дожидаясь окончания реальных таймингов.
3. **Генерация нагрузки:** Запускается скрипт с ботами, которые начинают делать конкурентные ставки в течение одной минуты.

**Примечание по производительности:**
Локально скрипт позволяет запускет 5000 ботов для проведения полноценного нагрузочного тестирования.
Однако, в **развернутой демо-версии (по ссылке - http://193.124.114.141/)** количество ботов ограничено до 50. Это сделано намеренно из-за ограничений производительности тестового хостинга, чтобы обеспечить стабильность демонстрации UI.
